#!/bin/sh

## This script uses sabre to demultiplex Peromyscus Library 2 (70GB, 576 samples)
## Usage: sbatch run_sabre_lib2_FINAL.sh

#SBATCH --account=def-mcfarlas
#SBATCH --time=12:00:00
#SBATCH --nodes=1
#SBATCH --mem=16G
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=4
#SBATCH --mail-user=sargon.yousefian@gmail.com
#SBATCH --mail-type=ALL
#SBATCH --job-name=sabre_lib2_576samples
#SBATCH --output=sabre_lib2-%j.out

## Load modules
module load StdEnv/2020 intel/2020.1.217 sabre

echo "========================================"
echo "Starting demultiplexing with sabre"
echo "Library: Peromyscus_Library_2"
echo "File size: 70GB uncompressed"
echo "Number of samples: 576"
echo "Start time: $(date)"
echo "========================================"

## Define paths
FASTQ_INPUT="/home/sydt/scratch/libraries/compressed/Peromyscus_Library_2_S76_L004_R1_001.fastq.gz"
BARCODE_INDEX="/home/sydt/scratch/libraries/lib2_barcode-index.txt"
OUTPUT_DIR="/home/sydt/scratch/libraries/library2"
UNKNOWN_OUTPUT="${OUTPUT_DIR}/unknown_barcode_Lib2.fq"

## Create output directory if it doesn't exist
mkdir -p ${OUTPUT_DIR}

## Change to output directory so sabre writes files there
cd ${OUTPUT_DIR}

## Check input file exists
if [ ! -f ${FASTQ_INPUT} ]; then
    echo "ERROR: Input file not found: ${FASTQ_INPUT}"
    exit 1
fi

## Check barcode index exists
if [ ! -f ${BARCODE_INDEX} ]; then
    echo "ERROR: Barcode index file not found: ${BARCODE_INDEX}"
    exit 1
fi

echo "Input file: ${FASTQ_INPUT}"
echo "Barcode index: ${BARCODE_INDEX}"
echo "Output directory: ${OUTPUT_DIR}"
echo ""

## Run sabre demultiplexing
## -f: input fastq file (can be .gz compressed)
## -b: barcode index file
## -u: output file for reads with unknown barcodes
## -m: number of mismatches allowed (2)

echo "Running sabre..."
sabre se -f ${FASTQ_INPUT} -b ${BARCODE_INDEX} -u ${UNKNOWN_OUTPUT} -m 2

## Check if sabre completed successfully
if [ $? -eq 0 ]; then
    echo ""
    echo "========================================"
    echo "Demultiplexing completed successfully!"
    echo "End time: $(date)"
    echo "========================================"
else
    echo ""
    echo "ERROR: Sabre failed with exit code $?"
    exit 1
fi

echo ""
echo "Output directory: ${OUTPUT_DIR}"
echo ""

## Count total output files
TOTAL_FILES=$(ls -1 ${OUTPUT_DIR}/Peromyscus*.fq 2>/dev/null | wc -l)
echo "Total demultiplexed files created: ${TOTAL_FILES}"
echo ""

## Count reads in unknown barcode file
if [ -f ${UNKNOWN_OUTPUT} ]; then
    UNKNOWN_COUNT=$(cat ${UNKNOWN_OUTPUT} | wc -l)
    UNKNOWN_READS=$((UNKNOWN_COUNT / 4))
    echo "Reads with unknown barcodes: ${UNKNOWN_READS}"
    UNKNOWN_SIZE=$(du -h ${UNKNOWN_OUTPUT} | cut -f1)
    echo "Unknown barcode file size: ${UNKNOWN_SIZE}"
    echo ""
fi

## Summary statistics for first 10 samples (to avoid overwhelming output)
echo "Sample read counts (showing first 10 samples):"
echo "----------------------------------------------"
COUNT=0
for fq_file in ${OUTPUT_DIR}/Peromyscus*.fq; do
    if [ -f "$fq_file" ]; then
        if [ $COUNT -lt 10 ]; then
            LINE_COUNT=$(cat "$fq_file" | wc -l)
            READS=$((LINE_COUNT / 4))
            SAMPLE=$(basename "$fq_file")
            printf "%-30s %10d reads\n" "$SAMPLE" "$READS"
        fi
        COUNT=$((COUNT + 1))
    fi
done

if [ $TOTAL_FILES -gt 10 ]; then
    echo "... (${TOTAL_FILES} total files created)"
fi

echo ""

## Calculate total output size
TOTAL_SIZE=$(du -sh ${OUTPUT_DIR} | cut -f1)
echo "Total output directory size: ${TOTAL_SIZE}"

echo ""
echo "========================================"
echo "All done!"
echo "========================================"
echo ""
echo "To view all sample read counts, run:"
echo "  for f in ${OUTPUT_DIR}/Peromyscus*.fq; do echo \"\$(basename \$f): \$(((\$(wc -l < \$f) / 4))) reads\"; done"
